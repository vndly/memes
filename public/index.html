<html lang="en">
  <head>
    <title>Memes</title>
      <meta name="viewport" content="width=device-width, user-scalable=no">
      <meta http-equiv="content-type" content="text/html; charset=utf-8" />
      <link rel="icon" href="favicon.png" type="image/x-icon" />
    <script>
      // Meme collection started on 27/11/2016

      let gifs = []
      let images = []

      function gif(url, tags)
      {
        return {
          url: 'https://media.giphy.com/media/' + url + '/giphy.gif',
          tags: tags
        }
      }

      function image(url, tags)
      {
        return {
          url: 'https://i.imgur.com/' + url + '.jpg',
          tags: tags
        }
      }

      function search(event, text)
      {
        if (event.keyCode == 13)
        {
          const urls = filter(text)
          const list = document.getElementById('result')

          while (list.firstChild) {
            list.removeChild(list.firstChild)
          }

          for (var url of urls)
          {
            const img = document.createElement('img')
            img.src = url
            img.addEventListener('click', function() {
              navigator.clipboard.writeText(img.src)  
            })

            list.appendChild(document.createElement('br'))
            list.appendChild(img)
            list.appendChild(document.createElement('br'))
          }
        }
      }

      function filter(text)
      {
        const result = []
        const pool = []
        if (document.getElementById('showGifs').checked) pool.push(...gifs)
        if (document.getElementById('showImages').checked) pool.push(...images)

        for (var meme of pool)
        {
          if (meme.tags.includes(text))
          {
          result.push(meme.url)
          }
        }

        return result
      }

      function loadList(json, updateUI)
      {
        if (updateUI) {
          document.getElementById('result').textContent = ''
          const input = document.getElementById('input')
          input.style.display = ''
          document.getElementById('filters').style.display = ''
          input.focus()
        }

        gifs = []
        images = []

        for (const gifKey of Object.keys(json.gif)) {
          gifs.push(gif(gifKey, json.gif[gifKey]))
        }

        for (const imageKey of Object.keys(json.image)) {
          images.push(image(imageKey, json.image[imageKey]))
        }
      }

      function loadLocalMemes()
      {
        const cache = localStorage.getItem('MEMES')
        
        if (cache) {
          loadList(JSON.parse(cache), true)
          loadRemoteMemes(false)
        } else {
          document.getElementById('result').textContent = 'Loading memesâ€¦'
          loadRemoteMemes(true)
        }
      }

      function loadRemoteMemes(updateUI)
      {
        const xhr = new XMLHttpRequest()
        xhr.open("GET", "https://script.google.com/macros/s/AKfycbyw8aRqFno3a1QGq10zLfgYnIQfLf4FG3-YOJjWHajxIFOIEl5m66VhISpYTZvLPe5Kwg/exec")
        xhr.onreadystatechange = function () {
           if (xhr.readyState === 4) {
              const json = JSON.parse(xhr.responseText)
              localStorage.setItem('MEMES', xhr.responseText)
              loadList(json, updateUI)
           }
        }
        xhr.send()
      }

      function loadMemes()
      {
        loadLocalMemes()
      }
    </script>
  </head>
  <body onload="loadMemes()">
    <input id='input' type='text' style='display:none;width:300px;font-size:1.5em' autofocus onkeyup='search(event, this.value.toLowerCase())' />
    <span id='filters' style='display:none'>
      <label><input type='checkbox' id='showGifs' checked /> GIF</label>
      <label><input type='checkbox' id='showImages' checked /> IMAGE</label>
    </span>
    <div id='result'></div>
  </body>
</html>